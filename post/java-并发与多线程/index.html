<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java 并发与多线程 | CadeCode</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/meta/favicon.ico">
    <link rel="alternate" type="application/rss+xml" href="https://cadecode.info/ /rss.xml" title=" RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://cadecode.info/ /feed.atom" title=" Atom Feed">
    <link rel="alternate" type="application/json" href="https://cadecode.info/ /feed.json" title=" JSON Feed">
    <meta name="description" content="并发的基本概念、线程的创建方式、线程状态以及线程同步、死锁、线程通信与线程池等">
    <link rel="preload" href="/assets/css/1.styles.9b3f04ec.css" as="style"><link rel="preload" href="/assets/js/app.f4ab58f6.js" as="script"><link rel="preload" href="/assets/js/11.9575ee42.js" as="script"><link rel="prefetch" href="/assets/js/10.c1ae2c49.js"><link rel="prefetch" href="/assets/js/12.61e0de30.js"><link rel="prefetch" href="/assets/js/13.3c6c03a9.js"><link rel="prefetch" href="/assets/js/14.f49a4da9.js"><link rel="prefetch" href="/assets/js/15.ee64f96d.js"><link rel="prefetch" href="/assets/js/16.30f2094c.js"><link rel="prefetch" href="/assets/js/17.ab555707.js"><link rel="prefetch" href="/assets/js/18.bbc07aa0.js"><link rel="prefetch" href="/assets/js/19.e24f1266.js"><link rel="prefetch" href="/assets/js/2.8ec9795a.js"><link rel="prefetch" href="/assets/js/20.46be83af.js"><link rel="prefetch" href="/assets/js/21.40bf79e0.js"><link rel="prefetch" href="/assets/js/22.14ac3424.js"><link rel="prefetch" href="/assets/js/23.e184be86.js"><link rel="prefetch" href="/assets/js/24.a381cb72.js"><link rel="prefetch" href="/assets/js/25.9013b43a.js"><link rel="prefetch" href="/assets/js/26.b60aae56.js"><link rel="prefetch" href="/assets/js/27.04c6856b.js"><link rel="prefetch" href="/assets/js/28.3de0b9b9.js"><link rel="prefetch" href="/assets/js/29.bdfbed6e.js"><link rel="prefetch" href="/assets/js/3.87d06ba9.js"><link rel="prefetch" href="/assets/js/30.caf07786.js"><link rel="prefetch" href="/assets/js/31.cbe1575d.js"><link rel="prefetch" href="/assets/js/32.fe52d239.js"><link rel="prefetch" href="/assets/js/33.010150c0.js"><link rel="prefetch" href="/assets/js/34.f229e166.js"><link rel="prefetch" href="/assets/js/35.d22472e6.js"><link rel="prefetch" href="/assets/js/36.bfcf0b1e.js"><link rel="prefetch" href="/assets/js/37.eb3cd28b.js"><link rel="prefetch" href="/assets/js/38.15a52a2a.js"><link rel="prefetch" href="/assets/js/39.66443117.js"><link rel="prefetch" href="/assets/js/4.2b8213a8.js"><link rel="prefetch" href="/assets/js/40.beea64fe.js"><link rel="prefetch" href="/assets/js/41.9897ba3c.js"><link rel="prefetch" href="/assets/js/42.f1240393.js"><link rel="prefetch" href="/assets/js/43.02eb515b.js"><link rel="prefetch" href="/assets/js/44.84661da8.js"><link rel="prefetch" href="/assets/js/45.4cb7ffc5.js"><link rel="prefetch" href="/assets/js/46.86f317c4.js"><link rel="prefetch" href="/assets/js/5.fac44ddd.js"><link rel="prefetch" href="/assets/js/6.bc076c8c.js"><link rel="prefetch" href="/assets/js/7.23cd3f44.js"><link rel="prefetch" href="/assets/js/8.b60442df.js"><link rel="prefetch" href="/assets/js/9.d96d6f65.js">
    <link rel="stylesheet" href="/assets/css/1.styles.9b3f04ec.css">
    <!--webpack externals css-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
</head>
<body>
<div id="app" data-server-rendered="true"><div class="global-container"><div class="head-container head-hide"><div class="head-content clearfix"><div class="head-logo"><a href="/"><img src="/meta/logo.png"> <!----></a></div> <div class="head-links"><div class="el-row"><div class="el-col el-col-24 el-col-xs-0 el-col-sm-24"><ul role="menubar" class="head-menu el-menu--horizontal el-menu" style="background-color:;"><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;"><i class="el-icon-s-home"></i>
                            Index
                        </li> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;"><i class="el-icon-search"></i>
                            Search
                        </li> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;"><i class="el-icon-info"></i>
                            About
                        </li> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;"><i class="el-icon-link"></i>
                            Links
                        </li></ul></div> <div class="el-col el-col-24 el-col-xs-24 el-col-sm-0"><ul role="menubar" class="head-menu el-menu--horizontal el-menu" style="background-color:;"><li role="menuitem" aria-haspopup="true" class="head-menu-sub el-submenu"><div class="el-submenu__title" style="border-bottom-color:transparent;color:;background-color:;">Menu<i class="el-submenu__icon-arrow el-icon-arrow-down"></i></div><div class="el-menu--horizontal" style="display:none;"><ul role="menu" class="el-menu el-menu--popup el-menu--popup-" style="background-color:;"> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;"><i class="el-icon-s-home"></i>
                                Index
                            </li> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;"><i class="el-icon-search"></i>
                                Search
                            </li> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;"><i class="el-icon-info"></i>
                                About
                            </li> <li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;background-color:;"><i class="el-icon-link"></i>
                                Links
                            </li></ul></div></li></ul></div></div></div></div></div> <div class="post-container component-content component-hide"><div class="post-title">Java 并发与多线程</div> <div class="post-tag"><a href="/search/Java"><i class="el-icon-paperclip"></i>
            Java
        </a></div> <div class="post-desc">并发的基本概念、线程的创建方式、线程状态以及线程同步、死锁、线程通信与线程池等</div> <div class="markdown-content J_markdownContent content__default"><h1 id="java-并发与多线程"><a href="#java-并发与多线程" class="header-anchor">#</a> Java 并发与多线程</h1> <h2 id="基本概念"><a href="#基本概念" class="header-anchor">#</a> 基本概念</h2> <h3 id="并发与并行"><a href="#并发与并行" class="header-anchor">#</a> 并发与并行</h3> <ol><li>并发：指两个或多个事件在同一时间间隔内发生 。当有多个线程在操作时,如果系统只有一个CPU,则它根本不可能真正同时进行一个以上的线程，它只能把CPU运行时间划分成若干个时间段,再将时间 段分配给各个线程执行，在一个时间段的线程代码运行时，其它线程处于挂起状。这种方式称之为并发(Concurrent)</li> <li>并行：指两个或者多个事件在同一时刻发生 。当系统有一个以上CPU时,则线程的操作有可能非并发。当一个CPU执行一个线程时，另一个CPU可以执行另一个线程，两个线程互不抢占CPU资源，可以同时进行，这种方式称之为并行(Parallel)</li></ol> <h3 id="进程与线程"><a href="#进程与线程" class="header-anchor">#</a> 进程与线程</h3> <ol><li>一个程序可能有多个进程，一个进程由多个线程和共享资源组成</li> <li>进程：拥有资源的基本单位</li> <li>线程：独立调度分派的基本单位</li></ol> <h2 id="线程"><a href="#线程" class="header-anchor">#</a> 线程</h2> <h3 id="创建线程"><a href="#创建线程" class="header-anchor">#</a> 创建线程</h3> <h4 id="thread"><a href="#thread" class="header-anchor">#</a> Thread</h4> <ol><li>继承 Thread 类（Thread 实现了 Runnable 接口）</li> <li>重写 run 方法</li> <li>start() 方法启动线程</li></ol> <h4 id="runnable"><a href="#runnable" class="header-anchor">#</a> Runnable</h4> <ol><li>实现 Runnable 接口</li> <li>重写 run 方法</li> <li>new Thread(Runnable target)，new Thread(Runnable target,String name)</li></ol> <blockquote><p>多个 Thread 实例共用一个 Runnable，这些线程的 run 方法相同，可以共享相同的数据</p> <p>但是存在线程同步问题</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunnableTest</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;售出&quot;</span> <span class="token operator">+</span> ticket <span class="token operator">+</span> <span class="token string">&quot;号票&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ticket<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">RunnableTest</span> rt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RunnableTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>rt<span class="token punctuation">,</span> <span class="token string">&quot;1号窗口&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>rt<span class="token punctuation">,</span> <span class="token string">&quot;2号窗口&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>print</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1</span>号窗口售出<span class="token number">10</span>号票
<span class="token number">1</span>号窗口售出<span class="token number">9</span>号票
<span class="token number">1</span>号窗口售出<span class="token number">8</span>号票
<span class="token number">1</span>号窗口售出<span class="token number">7</span>号票
<span class="token number">2</span>号窗口售出<span class="token number">7</span>号票
<span class="token number">2</span>号窗口售出<span class="token number">5</span>号票
<span class="token number">1</span>号窗口售出<span class="token number">6</span>号票
<span class="token number">2</span>号窗口售出<span class="token number">4</span>号票
<span class="token number">1</span>号窗口售出<span class="token number">3</span>号票
<span class="token number">2</span>号窗口售出<span class="token number">2</span>号票
<span class="token number">1</span>号窗口售出<span class="token number">1</span>号票
</code></pre></div><h4 id="匿名类"><a href="#匿名类" class="header-anchor">#</a> 匿名类</h4> <p>匿名类可以方便的访问方法的局部变量，但是必须声明为 final，因为匿名类和普通局部变量生命周期不一致</p> <p>jdk7 中已不再需要显示声明为 final，实际上被虚拟机自动隐式声明了</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//内容</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//内容</span>
        <span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="callable"><a href="#callable" class="header-anchor">#</a> Callable</h4> <ol><li><p>创建 Callable 的实现类,并冲写 call() 方法，该方法为线程执行体，并且该方法有返回值</p></li> <li><p>创建 Callable 实现类的实例，并用 FutuerTask 类来包装 Callable 对象，该 FutuerTask 封装了 Callable 对象 call() 方法的返回值</p></li> <li><p>实例化 FutuerTask 类，参数为 FutuerTask 接口实现类的对象来启动线程</p></li> <li><p>通过 FutuerTask 类的对象的 get() 方法来获取线程结束后的返回值</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CallableTest</span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">{</span>
    <span class="token comment">//重写执行体 call( )</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">call</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
           <span class="token comment">//</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Callable</span> call <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CallableTest</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//得到返回值</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;返回值:&quot;</span> <span class="token operator">+</span> f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>print</p> <div class="language-java extra-class"><pre class="language-java"><code>返回值：<span class="token number">10</span>
</code></pre></div></li></ol> <h3 id="线程方法"><a href="#线程方法" class="header-anchor">#</a> 线程方法</h3> <ol><li><p>线程执行体：run()</p></li> <li><p>启动线程：start()</p></li> <li><p>Thread 类方法</p> <table><thead><tr><th style="text-align:center;">方法</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">public final void setName(String name)</td> <td style="text-align:center;">改变线程名称</td></tr> <tr><td style="text-align:center;">public final void setPriority(int priority)</td> <td style="text-align:center;">设置优先级</td></tr> <tr><td style="text-align:center;">public final void setDaemon(boolean on)</td> <td style="text-align:center;">设为守护线程，当只剩下守护线程时自动结束</td></tr> <tr><td style="text-align:center;">public final boolean isAlive()</td> <td style="text-align:center;">测试线程是否处于活动状态</td></tr> <tr><td style="text-align:center;">public static void yield()</td> <td style="text-align:center;">暂停当前线程（回到就绪状态）</td></tr> <tr><td style="text-align:center;">public static void sleep(long millisec)</td> <td style="text-align:center;">进入休眠状态</td></tr> <tr><td style="text-align:center;">public final void join()</td> <td style="text-align:center;">暂停当前线程，等待调用该方法线程执行完毕</td></tr> <tr><td style="text-align:center;">public final void join(long millisec)</td> <td style="text-align:center;">暂停当前线程指定时间</td></tr> <tr><td style="text-align:center;">public static Thread currentThread()</td> <td style="text-align:center;">返回对当前正在执行的线程对象的引用</td></tr></tbody></table></li></ol> <h3 id="线程状态"><a href="#线程状态" class="header-anchor">#</a> 线程状态</h3> <ol><li><p>就绪状态：</p> <ul><li>start() 方法进入就绪状态，等待虚拟机调度</li> <li>运行状态调用 yield 方法会进入就绪状态</li> <li>lock 池中的线程获得锁后进入就绪状态</li></ul></li> <li><p>运行状态：就绪状态经过线程调度进去运行状态</p></li> <li><p>阻塞状态：</p> <ul><li>休眠：调用 sleep 方法</li> <li>对象 wait 池：调用 wait 或  join 方法，被 notify 后进入 lock 池</li> <li>对象 lock 池：未获得锁</li></ul></li> <li><p>死亡状态：run 方法执行完毕</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph TB
	T(新线程)--start方法--&gt;A(就绪状态)
	A--线程调度--&gt;B(运行状态)
	B--yield方法--&gt;A
	B--sleep方法--&gt;D(阻塞:休眠)
	B--wait或join方法--&gt;E(阻塞:wait池)
	B--未获得锁--&gt;F(阻塞:lock池)
	B--run方法执行完--&gt;C(死亡状态)
	D--时间到--&gt;A
	E--notify方法--&gt;F
	F--获得锁--&gt;A
</code></pre></div></li></ol> <h2 id="线程同步"><a href="#线程同步" class="header-anchor">#</a> 线程同步</h2> <blockquote><p>保证程序<strong>原子性、可见性、有序性</strong>的过程</p></blockquote> <h3 id="阻塞同步"><a href="#阻塞同步" class="header-anchor">#</a> 阻塞同步</h3> <blockquote><p>基于加锁争用的悲观并发策略</p></blockquote> <h4 id="synchronized"><a href="#synchronized" class="header-anchor">#</a> synchronized</h4> <ol><li>synchronized 含义</li></ol> <ul><li><p>使用 synchronized 可以锁住某一对象， 当其他线程也想锁住该对象以执行某段代码时，必须等待已经持有锁的线程释放锁</p></li> <li><p>释放锁的方式有互斥代码执行完毕、抛出异常、锁对象调用 wait 方法</p></li></ul> <ol start="2"><li><p>不同的使用方式代表不同的锁粒度</p> <ul><li>修饰普通方法 = synchronized(this)</li> <li>修饰静态方法 = synchronized(X.class)</li> <li>修饰代码块（对象 extends Object)</li></ul></li></ol> <h4 id="reentrantlock"><a href="#reentrantlock" class="header-anchor">#</a> ReentrantLock</h4> <ol><li><p>创建 Lock 锁</p> <p>ReentrantLock 实现了 Lock 接口， Lock lock = new ReentrantLock()</p></li> <li><p>Lock 含义</p> <ul><li><p>使用 lock() 方法表示当前线程占有 lock 对象</p></li> <li><p>释放该对象要显示掉用 unlock() 方法 ，多在 finally 块中进行释放</p></li></ul></li> <li><p>trylock 方法</p> <ul><li>synchronized 会一直等待锁，而 Lock 提供了 trylock 方法，在指定时间内试图占用</li> <li>使用 trylock， 释放锁时要判断，若占用失败，unlock 会抛出异常</li></ul></li> <li><p>Lock 的线程交互</p> <ul><li><p>通过 lock 对象得到一个 Condition 对象，Condition condition = lock.newCondition()</p></li> <li><p>调用这个Condition对象的：<strong>await，signal，signalAll</strong> 方法</p></li></ul></li> <li><p>示例</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LockTest</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token comment">//日志方法</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> dateStr <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dateStr <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span>
                <span class="token punctuation">{</span>
                    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;线程已启动&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;尝试占有lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    flag <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;成功占有lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;执行3秒业务操作&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;经过1秒钟尝试，占有lock失败，放弃占有&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">finally</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;释放lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;线程结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//先让 t1 先执行两秒</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e1<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            e1<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span>
                <span class="token punctuation">{</span>
                    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;线程启动&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;尝试占有lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    flag <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;成功占有lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;执行3秒的业务操作&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;经过1秒钟的尝试，占有lock失败，放弃占有&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">finally</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;释放lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;线程结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>print</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">01</span> t1 线程已启动
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">01</span> t1 尝试占有lock
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">01</span> t1 成功占有lock
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">01</span> t1 执行<span class="token number">3</span>秒业务操作
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">03</span> t2 线程启动
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">03</span> t2 尝试占有lock
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">04</span> t2 经过<span class="token number">1</span>秒钟的尝试，占有lock失败，放弃占有
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">04</span> t2 线程结束
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">04</span> t1 释放lock
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">04</span> t1 线程结束
</code></pre></div></li> <li><p>synchronized 和 Lock 区别</p> <ul><li>synchronized 是关键字，Lock 是接口， synchronized是内置的语言实现，Lock是代码层面的实现</li> <li>synchronized 执行完毕自动释放锁，Lock 需要显示 unlock()</li> <li>synchronized 会一直等待，尝试占用锁，Lock 可以使用 trylock，在一段时间内尝试占用，时间到占用失败则放弃</li></ul></li></ol> <h3 id="非阻塞同步"><a href="#非阻塞同步" class="header-anchor">#</a> 非阻塞同步</h3> <blockquote><p>非阻塞同步是一种基于冲突检测和数据更新的乐观并发策略</p></blockquote> <h4 id="actomic-类"><a href="#actomic-类" class="header-anchor">#</a> actomic 类</h4> <ol><li><p>原子操作</p> <ul><li>原子操作是不可中断的操作，必须一次性执行完成</li> <li>赋值操作是原子操作，但 a++ 不是原子操作， 而是取值、加一、赋值三个步骤</li> <li>一个线程取 i 的值后，还没来得及加一，第二个线程也来取值，就产生了线程安全问题</li></ul></li> <li><p>actomic 类的使用</p> <ul><li>jdk6 以后，新增包 java.util.concurrent.atomic，里面有各种原子类，比如 AtomicInteger</li> <li>AtomicInteger 提供了各种自增，自减等方法，这些方法都是原子性的。换句话说，自增方法 incrementAndGet 是线程安全的</li> <li>10000 个线程做 value 加一的操作，用 a++ 方式得出不准确的结果，用原子类 AtomicInteger 的 addAndGet() 方法得出正确结果</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadTest</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> value1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">AtomicInteger</span> value2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//原子整型类</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    value1<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    value2<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//value++的原子操作</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>value2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>print</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">99996</span>
<span class="token number">100000</span>
</code></pre></div></li></ol> <h3 id="无同步方案"><a href="#无同步方案" class="header-anchor">#</a> 无同步方案</h3> <blockquote><p>如果一个方法不涉及共享数据，那么他天生就是线程安全的</p></blockquote> <h4 id="可重入代码"><a href="#可重入代码" class="header-anchor">#</a> 可重入代码</h4> <blockquote><p>可以在代码执行的任何时刻中断它，转而去执行另外一段代码，在控制权返回之后，原来的程序不会出现任何的错误</p></blockquote> <ol><li><p>一个方法返回结果是可以预测的，输入了相同的数据，就能返回相同的结果，那这个方法就具有可重入性，也就是线程安全的</p></li> <li><p>栈封闭是一种可重用代码</p> <p>多个线程访问同一个方法的<strong>局部变量</strong>时，不会出现线程安全问题，因为<strong>局部变量保存在虚拟机栈</strong>中，属于线程的<strong>私有区域</strong>，所以不会出现线程安全性</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadTest</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            value<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">add</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">add</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>print</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1000</span>
<span class="token number">1000</span>
</code></pre></div></li></ol> <h4 id="线程本地存储"><a href="#线程本地存储" class="header-anchor">#</a> 线程本地存储</h4> <ol><li><p>把共享数据的可见范围限制在同一个线程之内，即便无同步也能做到避免数据争用</p></li> <li><p>使用 java.lang.ThreadLocal 类来实现<strong>线程本地存储</strong>功能</p> <ul><li>ThreadLocal 变量是一个不同线程可以拥有不同值的变量，所有的线程可以共享一个ThreadLocal对象</li> <li>任意一个线程的 ThreadLocal 值发生变化，不会影响其他的线程</li> <li>用set()和get()方法对ThreadLocal变量进行赋值和查看其值</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalDemo</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocal</span> threadLocal1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
        <span class="token punctuation">{</span>
            threadLocal1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadLocal1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token operator">-&gt;</span> threadLocal1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>print</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1</span>
</code></pre></div></li> <li><p>ThreadLocal 原理</p> <ul><li>每个线程都有一个 ThreadLocal.ThreadLocalMap 对象，调用 threadLocal1.set(T value) 方法时，将 threadLoacl1 和 value 键值对存入 map</li> <li>ThreadLocalMap 底层数据结构可能导致内存泄露，尽可能在使用 ThreadLocal 后调用 remove()方法</li></ul></li></ol> <h2 id="死锁"><a href="#死锁" class="header-anchor">#</a> 死锁</h2> <h3 id="死锁条件"><a href="#死锁条件" class="header-anchor">#</a> 死锁条件</h3> <ol><li>互斥条件</li> <li>请求与保持条件</li> <li>不可剥夺条件</li> <li>循环等待条件（环路条件）</li></ol> <h3 id="java-死锁示例"><a href="#java-死锁示例" class="header-anchor">#</a> Java 死锁示例</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Object</span> o1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> o2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o1<span class="token punctuation">)</span><span class="token comment">//占有 o1</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;t1 已占有 O1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//停顿1000毫秒，另一个线程有足够的时间占有 o1</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;t1 试图占有 o2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;t1 等待中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o2<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;t1 已占有 O2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o2<span class="token punctuation">)</span>  <span class="token comment">//占有 o2</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;t2 已占有 o2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//停顿1000毫秒，另一个线程有足够的时间占有 o2</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;t2 试图占有 o1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;t2 等待中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o1<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;t2 已占有 O1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>print</p> <div class="language-java extra-class"><pre class="language-java"><code>t1 已占有 O1
t2 已占有 o2
t1 试图占有 o2
t1 等待中
t2 试图占有 o1
t2 等待中
</code></pre></div><h2 id="线程通信"><a href="#线程通信" class="header-anchor">#</a> 线程通信</h2> <ol><li><p>Object 类方法</p> <table><thead><tr><th style="text-align:center;">方法</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">wait()</td> <td style="text-align:center;">线程进入等待池</td></tr> <tr><td style="text-align:center;">notify()</td> <td style="text-align:center;">唤醒等待当前线程锁的线程</td></tr> <tr><td style="text-align:center;">notifyAll()</td> <td style="text-align:center;">唤醒所有线程，优先级高的优先唤醒</td></tr></tbody></table> <blockquote><p>为什么这些方法设置在 Object 对象上？</p> <p>表面上看，因为任何对象都可以加锁</p> <p>底层上说，java 多线程同步的 Object Monitor 机制，每个对象上都设置有类似于集合的数据结构，储存当前获得锁的线程、等待获得锁的线程（lock set）、等待被唤醒的线程（wait set）</p></blockquote></li> <li><p>生产者消费者模型</p> <ul><li>sleep 方法，让出 cpu，但不放下锁</li> <li>wait 方法，进入锁对象的等待池，放下锁</li></ul></li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerAndConsumer</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Goods</span> goods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Goods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//生产者线程</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> goods<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//消费者线程</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> goods<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Goods</span><span class="token comment">//商品类</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//商品数目</span>
    <span class="token keyword">int</span> space <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//空位总数</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">&lt;</span> space<span class="token punctuation">)</span><span class="token comment">//有空位可放，可以生产</span>
        <span class="token punctuation">{</span>
            num<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;放入一个商品，现有&quot;</span> <span class="token operator">+</span> num <span class="token operator">+</span> <span class="token string">&quot;个商品，&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>space <span class="token operator">-</span> num<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;个空位&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//唤醒等待该锁的线程</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token comment">//无空位可放，等待空位</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;没有空位可放，等待拿出&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进入该锁对象的等待池</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//有商品可拿</span>
        <span class="token punctuation">{</span>
            num<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;拿出一个商品，现有&quot;</span> <span class="token operator">+</span> num <span class="token operator">+</span> <span class="token string">&quot;个商品，&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>space <span class="token operator">-</span> num<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;个空位&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//唤醒等待该锁的线程</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token comment">///等待生产产品</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;没有商品可拿，等待放入&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进入该锁对象的等待池</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>print</p> <div class="language-java extra-class"><pre class="language-java"><code>没有商品可拿，等待放入
放入一个商品，现有<span class="token number">1</span>个商品，<span class="token number">9</span>个空位
放入一个商品，现有<span class="token number">2</span>个商品，<span class="token number">8</span>个空位
拿出一个商品，现有<span class="token number">1</span>个商品，<span class="token number">9</span>个空位
放入一个商品，现有<span class="token number">2</span>个商品，<span class="token number">8</span>个空位
放入一个商品，现有<span class="token number">3</span>个商品，<span class="token number">7</span>个空位
放入一个商品，现有<span class="token number">4</span>个商品，<span class="token number">6</span>个空位
拿出一个商品，现有<span class="token number">3</span>个商品，<span class="token number">7</span>个空位
放入一个商品，现有<span class="token number">4</span>个商品，<span class="token number">6</span>个空位
···
</code></pre></div><h2 id="线程池"><a href="#线程池" class="header-anchor">#</a> 线程池</h2> <blockquote><p>线程的启动和结束都是比较消耗时间和占用资源的，如果在系统中用到了很多的线程，大量的启动和结束动作会严重影响性能</p> <p>线程池很像<strong>生产者消费者模式</strong>，消费的对象是一个一个的能够运行的任务</p></blockquote> <ol><li><p>设计思路</p> <ul><li>准备任务容器，可用 List，存放任务</li> <li>线程池类构造方法中创建多个执行者线程</li> <li>任务容器为空时，所有线程 wait</li> <li>当外部线程向任务容器加入任务，就会有执行者线程被 notify</li> <li>执行任务完毕后，没有接到新任务，就回归等待状态</li></ul></li> <li><p>实现一个线程池</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPool</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> poolSize<span class="token punctuation">;</span><span class="token comment">// 线程池大小</span>
    <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 任务容器</span>
    <span class="token keyword">public</span> <span class="token class-name">ThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> poolSize<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>poolSize <span class="token operator">=</span> poolSize<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token comment">//启动 poolSize 个任务执行者线程</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> poolSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">new</span> <span class="token class-name">ExecuteThread</span><span class="token punctuation">(</span><span class="token string">&quot;执行者线程 &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span><span class="token comment">//添加任务</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            tasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;加入新任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tasks<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 唤醒等待的任务执行者线程</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">class</span> <span class="token class-name">ExecuteThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token comment">//等待执行任务的线程</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Runnable</span> task<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">ExecuteThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;启动：&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token keyword">try</span>
                        <span class="token punctuation">{</span>
                            tasks<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    task <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">removeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    tasks<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 允许添加任务的线程可以继续添加任务</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 接到任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行任务</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">ThreadPool</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">Runnable</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//创建任务</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//任务内容</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot; 执行任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            pool<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加入任务</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>print</p> <div class="language-java extra-class"><pre class="language-java"><code>main 加入新任务
启动：执行者线程 <span class="token number">0</span>
执行者线程 <span class="token number">0</span> 接到任务
执行者线程 <span class="token number">0</span> 执行任务
启动：执行者线程 <span class="token number">1</span>
启动：执行者线程 <span class="token number">2</span>
main 加入新任务
执行者线程 <span class="token number">2</span> 接到任务
执行者线程 <span class="token number">2</span> 执行任务
main 加入新任务
执行者线程 <span class="token number">2</span> 接到任务
执行者线程 <span class="token number">2</span> 执行任务
</code></pre></div></li> <li><p>java 线程池类</p> <ul><li><p>默认线程池类 ThreadPoolExecutor 在 java.util.concurrent 包下</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ThreadPoolExecutor</span> threadPool<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
第一个参数 int 类型, 10 表示这个线程池初始化了 10 个线程在里面工作
第二个参数 int 类型, 15 表示如果 10 个线程不够用了，就会自动增加到最多 15个 线程
第三个参数 60 结合第四个参数 TimeUnit.SECONDS，表示经过 60 秒，多出来的线程还没有接到任务，就会回收，最后保持池子里就 10 个
第五个参数 BlockingQueue 类型,new LinkedBlockingQueue() 用来放任务的集合
*/</span>
</code></pre></div></li> <li><p>execute() 方法添加新任务</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestThread</span> 
<span class="token punctuation">{</span>   
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> 
    <span class="token punctuation">{</span>
        <span class="token class-name">ThreadPoolExecutor</span> threadPool<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span><span class="token comment">//添加任务</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>    
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p>java 中几种线程池</p> <blockquote><p>java 线程池的顶级接口是 <strong>Executor</strong> ,子接口是 <strong>ExecutorService</strong> ，子接口使用更广泛</p> <p>Executors 类提供了一系列工厂方法用于创建线程池，返回的线程池实现了 ExecutorService 接口</p></blockquote> <ul><li>newCachedThreadPool有缓冲的线程池，线程数 JVM 控制，有线程可使用时不会创建新线程</li> <li>newFixedThreadPool，固定大小的线程池，任务量超过线程数时，任务存入等待队列</li> <li>newScheduledThreadPool，创建一个线程池，可安排在给定延迟后运行命令或者定期地执行</li> <li>newSingleThreadExecutor，只有一个线程，顺序执行多个任务，若意外终止，则会新创建一个</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//缓冲线程池</span>
threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//固定大小的线程池</span>
threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//定时任务线程池</span>
threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//单线程的线程池</span>
threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>···<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//默认线程池，多个可控参数</span>
</code></pre></div></li></ol> <h2 id="线程安全类"><a href="#线程安全类" class="header-anchor">#</a> 线程安全类</h2> <ol><li>StringBuffer：内部方法用 synchronized 修饰</li> <li>Vetort：继承于 AbstractList</li> <li>Stack：继承于 Vector</li> <li>HashTable：继承于 Dictionary，实现了 Map 接口</li> <li>Property：继承于 HashTable，实现了 Map 接口</li> <li>concurrentHashMap：分段加锁机制</li></ol></div> <div class="catalog-container" style="display:none;"><!----> <div class="catalog-open"><i class="el-icon-s-operation"></i></div></div> <div class="comment-container"><div class="comment-title"><i class="el-icon-s-comment"></i>
        Comment here, be cool~
    </div> <div class="J_comment"></div></div></div> <div class="foot-container"><div class="foot-links"><a href="https://cadecode.info/rss.xml" target="_blank">Rss</a> <a href="https://github.com/cadecode" target="_blank">
            Github
        </a><a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=eBsZHB0bFxwdOB4XABUZERRWGxcV" target="_blank">
            Email
        </a><a href="https://www.cnblogs.com/pgjett" target="_blank">
            Cnblogs
        </a></div> <div class="foot-meta"><p>Copyright © 2020 CadeCode</p> <p>
            Theme
            <a href="https://github.com/cadecode/vuepress-theme-2zh" target="_blank">2zh</a>
            powered by
            <a href="https://www.vuepress.cn/" target="_blank">VuePress</a></p> <p id="/post/java-%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/" data-flag-title="Java 并发与多线程" class="leancloud_visitors">
            本页访问次数 <i class="leancloud-visitors-count">0</i></p></div></div> <div class="backtop-container" style="display:none;"><i class="el-icon-caret-top"></i></div> <div class="loading-container"><div class="loading-box"><span>Loading</span></div></div></div><div class="global-ui"></div></div>
<script src="/assets/js/app.f4ab58f6.js" defer></script><script src="/assets/js/11.9575ee42.js" defer></script>
<!--webpack externals-->
<script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@8.8.2/dist/mermaid.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script>
</body>
</html>